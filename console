#!/usr/bin/env php
<?php
declare(strict_types = 1);

use Externals\Application\Command\InitCommand;
use Externals\Domain\Command\Handler\ReceiveEmailHandler;
use Externals\Domain\Command\ReceiveEmail;
use Imapi\Client;
use Imapi\Query\QueryBuilder;
use Silly\Application;
use Symfony\Component\Console\Output\OutputInterface;

require_once __DIR__ . '/vendor/autoload.php';
require_once __DIR__ . '/.puli/GeneratedPuliFactory.php';

$kernel = new \Externals\Application\Application([], [
    'error-handler',
    'app',
]);

$application = new Application();
$application->useContainer($kernel->getContainer(), true, true);

$application->command('sync', function (Client $imapClient, ReceiveEmailHandler $receiveEmailHandler, OutputInterface $output) {
    $query = QueryBuilder::create('INBOX')
        ->youngerThan(3600*10) // 1 day
        ->getQuery();
    $emails = $imapClient->getEmails($query);

    $output->writeln(sprintf('<comment>%d emails to synchronize</comment>', count($emails)));

    foreach ($emails as $email) {
        $receiveEmailHandler(new ReceiveEmail($email));
    }
});

$application->command('init', InitCommand::class);

$application->run();
